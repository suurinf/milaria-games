<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Пройдённые игры Миларии — с диагностикой</title>
<meta name="color-scheme" content="dark">
<style>
  :root{ --bg:#0b0f14; --panel:#0f1723; --muted:#9aa7b1; --text:#e7edf2; --accent:#67b8ff; --border:#1e2632; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Ubuntu,Arial;background:linear-gradient(180deg,#0b0f14 0%, #0f1520 60%, #0b0f14 100%);color:var(--text)}
  .wrap{max-width:1200px;margin:32px auto;padding:0 20px 56px}
  h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px;font-size:clamp(26px,3vw,36px)}
  .subtitle{color:var(--muted);font-size:14px;margin-bottom:18px}
  .diag{background:#0f1723;border:1px solid #1e2632;border-radius:12px;padding:12px 14px;color:#cfe4ff;margin:10px 0 22px}
  .section{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid var(--border);border-radius:14px;padding:14px 14px 6px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .section-title{font-size:clamp(18px,2.4vw,22px);font-weight:700;margin:26px 0 10px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:26px 0}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:rgba(20,26,36,.85);backdrop-filter:blur(6px)}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top;font-size:14px;line-height:1.45}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .cover img{width:120px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border);background:#0d131b;box-shadow:0 3px 12px rgba(0,0,0,.35)}
  .badge{display:inline-flex;align-items:center;gap:6px;font-weight:700;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#101725;min-width:44px;justify-content:center}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  .note{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Пройдённые игры Миларии</h1>
    <div class="subtitle">Версия с диагностикой: покажет строки CSV и счётчики по секциям.</div>
  </header>

  <div class="diag" id="diag">загрузка…</div>

  <section class="section" id="secCompleted">
    <div class="section-title">Раздел 1 — Пройдённые</div>
    <div id="tblCompleted"></div>
  </section>

  <div class="hr"></div>

  <section class="section" id="secDropped">
    <div class="section-title">Раздел 2 — Брошенные</div>
    <div id="tblDropped"></div>
  </section>

  <div class="hr"></div>

  <section class="section" id="secReviews">
    <div class="section-title">Раздел 3 — Рецензии / мнения</div>
    <div id="tblReviews"></div>
  </section>
</div>

<script>
const CSV_PATH = "milariatube_games.csv";
const norm = s => (s||"").toString().trim().toLowerCase().replace(/\s+/g,' ');

function guessDelimiter(line){
  let c=0,s=0,inq=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){ if(inq && line[i+1] === '"'){ i++; } else inq=!inq; }
    else if(!inq && ch === ',') c++;
    else if(!inq && ch === ';') s++;
  }
  return s>c?';':',';
}

function parseCSV(text){
  const raw = text.replace(/^\uFEFF/,'');                              // BOM
  const lines = raw.split(/\r\n|\n|\r/);                               // ANY newline
  if(!lines.length) return {header:[], rows:[], delim:','};
  const delim = guessDelimiter(lines[0]);
  function parseLine(line){
    const out=[]; let cur="", inq=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){ if(inq && line[i+1] === '"'){ cur+='"'; i++; } else inq=!inq; }
      else if(ch === delim && !inq){ out.push(cur); cur=""; }
      else{ cur+=ch; }
    }
    out.push(cur);
    return out.map(s=>s.trim());
  }
  const header = parseLine(lines.shift());
  const rows = lines.filter(l=>l.length>0).map(parseLine);
  return {header, rows, delim};
}

function pickIndexes(header){
  const h = header.map(norm);
  const idx = {section:-1,title:-1,rating:-1,status:-1,opinion:-1,link:-1,cover:-1};
  const want = {
    section:["section","раздел"],
    title:["название игры","название","игра","title","game"],
    rating:["оценка (из 10)","оценка","рейтинг","score","rating"],
    status:["статус","status"],
    opinion:["краткое мнение","мнение","описание","comment","review"],
    link:["ссылка на рецензию (url)","ссылка на рецензию","ссылка","url","link"],
    cover:["обложка (url)","обложка","cover","image","img","thumbnail"]
  };
  for(let i=0;i<h.length;i++){
    for(const k of Object.keys(want)){
      if(idx[k]!==-1) continue;
      if(want[k].some(w=>h[i]===w || h[i].includes(w))) { idx[k]=i; break; }
    }
  }
  if(h.length >= 6){
    if(idx.section === -1) idx.section = 0;
    if(idx.title   === -1) idx.title   = 1;
    if(idx.rating  === -1 && h.length >= 7) idx.rating = 2;
    if(idx.status  === -1) idx.status  = (idx.rating !== -1 ? 3 : 2);
    if(idx.opinion === -1) idx.opinion = (idx.rating !== -1 ? 4 : 3);
    if(idx.link    === -1) idx.link    = (idx.rating !== -1 ? 5 : 4);
    if(idx.cover   === -1) idx.cover   = (idx.rating !== -1 ? 6 : 5);
  }
  return idx;
}

function renderTable(mountId, rows){
  const mount = document.getElementById(mountId);
  if(!rows.length){ mount.innerHTML = "<div style='opacity:.7'>— пусто —</div>"; return; }
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");
  table.appendChild(thead); table.appendChild(tbody);
  const trh = document.createElement("tr");
  ["Обложка","Название игры","Оценка","Статус","Краткое мнение","Ссылка"].forEach(t=>{
    const th=document.createElement("th"); th.textContent=t; trh.appendChild(th);
  });
  thead.appendChild(trh);
  rows.forEach(rec=>{
    const [_,title,rating,status,opinion,link,cover] = rec;
    const tr=document.createElement("tr");
    const tdC=document.createElement("td"); tdC.className="cover"; const img=new Image(); img.src=cover||""; img.alt=""; img.loading="lazy"; img.referrerPolicy="no-referrer"; tdC.appendChild(img); tr.appendChild(tdC);
    const tdT=document.createElement("td"); tdT.textContent=title||""; tr.appendChild(tdT);
    const tdR=document.createElement("td"); const badge=document.createElement("span"); badge.className="badge"; badge.textContent=(rating&&rating.toString().trim())?rating:"—"; tdR.appendChild(badge); tr.appendChild(tdR);
    const tdS=document.createElement("td"); tdS.textContent=status||""; tr.appendChild(tdS);
    const tdO=document.createElement("td"); tdO.textContent=opinion||""; tr.appendChild(tdO);
    const tdL=document.createElement("td"); if(link){ const a=document.createElement("a"); a.href=link; a.textContent="Пост"; a.target="_blank"; tdL.appendChild(a);} else tdL.textContent="—"; tr.appendChild(tdL);
    tbody.appendChild(tr);
  });
  mount.innerHTML=""; mount.appendChild(table);
}

async function main(){
  const diag = document.getElementById('diag');
  const res = await fetch(CSV_PATH,{cache:"no-store"});
  const txt = await res.text();
  const parsed = parseCSV(txt);
  const idx = pickIndexes(parsed.header);

  // Собираем записи
  const all = parsed.rows.map(r => [
    r[idx.section]||"", r[idx.title]||"", r[idx.rating]||"", r[idx.status]||"",
    r[idx.opinion]||"", r[idx.link]||"", r[idx.cover]||""
  ]);
  const completed = all.filter(r => (r[0]||"").trim() === "Пройдённые");
  const dropped   = all.filter(r => (r[0]||"").trim() === "Брошенные");
  const reviews   = all.filter(r => (r[0]||"").trim() === "Рецензии / мнения");

  diag.innerHTML = `
    <b>Диагностика:</b><br>
    Строк всего (без заголовка): <code>${parsed.rows.length}</code><br>
    Индексы колонок: <code>${JSON.stringify(idx)}</code><br>
    Счётчики — Пройдённые: <code>${completed.length}</code> · Брошенные: <code>${dropped.length}</code> · Рецензии: <code>${reviews.length}</code>
  `;

  renderTable("tblCompleted", completed);
  renderTable("tblDropped", dropped);
  renderTable("tblReviews", reviews);
}
main();
</script>
</body>
</html>
